<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Uno Online P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #2c3e50; color: white; text-align: center; padding: 20px; }
        .window { background: #34495e; padding: 20px; border-radius: 10px; display: inline-block; min-width: 300px; }
        .hidden { display: none; }
        button { padding: 10px 20px; margin: 10px; cursor: pointer; border: none; border-radius: 5px; background: #3498db; color: white; }
        input { padding: 10px; border-radius: 5px; border: none; width: 80%; }
        #log { background: #1a252f; padding: 10px; height: 100px; overflow-y: auto; margin-top: 10px; font-size: 0.8rem; text-align: left; }
    </style>
</head>
<body>

    <div id="menu" class="window">
        <h1>Uno Game</h1>
        <p id="my-name-display">Профиль: Гость</p>
        <button onclick="showScreen('profile')">Изменить профиль</button><br>
        <button onclick="createRoom()">Создать комнату</button><br>
        <button onclick="showScreen('join')">Присоединиться</button>
    </div>

    <div id="profile" class="window hidden">
        <h2>Настройка профиля</h2>
        <input type="text" id="nickInput" placeholder="Твой ник">
        <button onclick="saveNick()">Сохранить</button>
    </div>

    <div id="join" class="window hidden">
        <h2>Вход в комнату</h2>
        <input type="text" id="roomIdInput" placeholder="Код комнаты">
        <button onclick="joinRoom()">Войти</button>
        <button onclick="showScreen('menu')">Назад</button>
    </div>

    <div id="gameRoom" class="window hidden">
        <h2>Комната: <span id="roomCodeDisplay">---</span></h2>
        <div id="playerList">Игроки: </div>
        <hr>
        <button id="actionBtn" onclick="sendAction()" class="hidden">Бросить кубик</button>
        <div id="log"></div>
        <button onclick="location.reload()">Выйти</button>
    </div>

<script>
    let peer = null;
    let connections = []; // Только для Хоста: список всех подключенных друзей
    let myConn = null;    // Только для Гостя: связь с Хостом
    let myNick = localStorage.getItem('uno-nick') || 'Игрок_' + Math.floor(Math.random()*1000);

    document.getElementById('my-name-display').innerText = "Профиль: " + myNick;

    function showScreen(id) {
        document.querySelectorAll('.window').forEach(w => w.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function saveNick() {
        myNick = document.getElementById('nickInput').value || myNick;
        localStorage.setItem('uno-nick', myNick);
        document.getElementById('my-name-display').innerText = "Профиль: " + myNick;
        showScreen('menu');
    }

    // --- ЛОГИКА ХОСТА (Создатель комнаты) ---
    function createRoom() {
        const roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
        peer = new Peer(roomId);

        peer.on('open', (id) => {
            document.getElementById('roomCodeDisplay').innerText = id;
            showScreen('gameRoom');
            addToLog("Комната создана. Ждем друзей...");
            updatePlayerList([myNick + " (Вы)"]);
        });

        peer.on('connection', (conn) => {
            connections.push(conn);
            conn.on('data', (data) => {
                if(data.type === 'join') {
                    addToLog(data.nick + " присоединился!");
                    // Рассылаем всем обновленный список (в будущем)
                }
                if(data.type === 'action') {
                    addToLog(data.nick + " выбросил: " + data.value);
                }
            });
        });
    }

    // --- ЛОГИКА ГОСТЯ (Тот, кто входит) ---
    function joinRoom() {
        const code = document.getElementById('roomIdInput').value.toUpperCase();
        peer = new Peer(); // Создаем случайный ID для себя

        peer.on('open', () => {
            myConn = peer.connect(code);
            myConn.on('open', () => {
                showScreen('gameRoom');
                document.getElementById('roomCodeDisplay').innerText = code;
                document.getElementById('actionBtn').classList.remove('hidden');
                myConn.send({ type: 'join', nick: myNick });
                addToLog("Вы подключились к хосту!");
            });
        });
    }

    function sendAction() {
        const val = Math.floor(Math.random() * 6) + 1;
        if(myConn) {
            myConn.send({ type: 'action', nick: myNick, value: val });
            addToLog("Вы выбросили: " + val);
        }
    }

    function addToLog(msg) {
        const log = document.getElementById('log');
        log.innerHTML += `<div>${msg}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    function updatePlayerList(list) {
        document.getElementById('playerList').innerText = "Игроки: " + list.join(', ');
    }
</script>
</body>
</html>